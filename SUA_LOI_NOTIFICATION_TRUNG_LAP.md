# ğŸ”§ CÃ¡ch Sá»­a Lá»—i ThÃ´ng BÃ¡o TrÃ¹ng Láº·p (Duplicate Notifications)\n\n## ğŸ” Váº¥n Äá» Báº¡n Gáº·p\n\n```\nBáº¡n tháº¥y trong logs:\n- ID: 380673124, Title: Nháº¯c uá»‘ng thuá»‘c         â† Warning trÆ°á»›c 1-3 phÃºt\n- ID: 805560298, Title: Nháº¯c uá»‘ng thuá»‘c         â† Warning trÆ°á»›c 1-3 phÃºt\n- ID: 754554420, Title: Äáº¿n giá» uá»‘ng thuá»‘c! ğŸ’Š  â† At exact time\n- ID: 660068680, Title: Äáº¿n giá» uá»‘ng thuá»‘c! ğŸ’Š  â† At exact time\n\nâš ï¸ Váº¤NÄá»€: CÃ¹ng thuá»‘c cÃ³ nhiá»u notification liÃªn tiáº¿p\n          KhÃ´ng kiá»ƒm tra xem Ä‘Ã£ gá»­i hÃ´m nay hay chÆ°a\n          Má»—i láº§n kiá»ƒm tra Ä‘á»u táº¡o notification má»›i\n```\n\n## âœ… Giáº£i PhÃ¡p\n\n### Ã TÆ°á»Ÿng ChÃ­nh\n\n**ThÃªm tracking vÃ o database** Ä‘á»ƒ ghi nháº­n:\n- NgÃ y cuá»‘i cÃ¹ng Ä‘Ã£ gá»­i thÃ´ng bÃ¡o\n- Sá»‘ láº§n Ä‘Ã£ gá»­i (cho debug)\n\nKhi kiá»ƒm tra notification, kiá»ƒm tra Ä‘iá»u kiá»‡n:\n```\nNáº¿u (Ä‘Ã£ gá»­i hÃ´m nay) {\n  â†’ Bá» QUA (skip)\n} Náº¿u (Ä‘Ã£ tá»›i giá» AND chÆ°a gá»­i hÃ´m nay) {\n  â†’ HIá»‚N THá»Š notification\n  â†’ Cáº¬P NHáº¬T database: last_notification_sent_date = hÃ´m nay\n}\n```\n\n---\n\n## ğŸ—„ï¸ BÆ°á»›c 1: ThÃªm Cá»™t Database\n\n### TrÃªn Supabase\n\n**VÃ o**: Database â†’ SQL Editor â†’ New Query\n\nCháº¡y SQL nÃ y:\n```sql\nALTER TABLE public.medicine_schedule_times\nADD COLUMN IF NOT EXISTS last_notification_sent_date date null,\nADD COLUMN IF NOT EXISTS notification_sent_count integer null default 0;\n\nCOMMENT ON COLUMN public.medicine_schedule_times.last_notification_sent_date \nIS 'NgÃ y cuá»‘i cÃ¹ng Ä‘Ã£ gá»­i thÃ´ng bÃ¡o cho láº§n uá»‘ng nÃ y';\n\nCOMMENT ON COLUMN public.medicine_schedule_times.notification_sent_count \nIS 'Sá»‘ láº§n Ä‘Ã£ gá»­i thÃ´ng bÃ¡o (Ä‘á»ƒ debug)';\n\nCREATE INDEX IF NOT EXISTS idx_medicine_schedule_times_last_notification_sent_date \nON public.medicine_schedule_times USING btree (last_notification_sent_date);\n```\n\n**Káº¿t Quáº£**:\n- ThÃªm 2 cá»™t má»›i vÃ o báº£ng `medicine_schedule_times`\n- `last_notification_sent_date` = ngÃ y cuá»‘i gá»­i (null = chÆ°a gá»­i)\n- `notification_sent_count` = sá»‘ láº§n gá»­i (0 = chÆ°a gá»­i)\n\n### Kiá»ƒm Tra\n\nTrong Supabase:\n1. Table Editor â†’ medicine_schedule_times\n2. Pháº£i tháº¥y 2 cá»™t má»›i: `last_notification_sent_date` vÃ  `notification_sent_count`\n3. Táº¥t cáº£ giÃ¡ trá»‹ = null/0 (chÆ°a gá»­i láº§n nÃ o)\n\n---\n\n## ğŸ’» BÆ°á»›c 2: Cáº­p Nháº­t Code\n\n### File: `lib/services/background_task_service.dart`\n\n**Thay Äá»•i**: HÃ m `_handleMedicineCheckTask()`\n\n**Logic Má»›i**:\n```dart\n// Kiá»ƒm tra xem Ä‘Ã£ gá»­i thÃ´ng bÃ¡o hÃ´m nay chÆ°a\nfinal todayStr = '${now.year}-${now.month.toString().padLeft(2, '0')}-${now.day.toString().padLeft(2, '0')}';\n\n// Láº¥y dá»¯ liá»‡u tá»« database\nfinal scheduleTimeData = await supabase\n    .from('medicine_schedule_times')\n    .select('last_notification_sent_date, notification_sent_count')\n    .eq('id', scheduleTime.id)\n    .single();\n\nfinal lastSentDate = scheduleTimeData['last_notification_sent_date'] as String?;\nfinal hasAlreadySentToday = lastSentDate == todayStr;  // â† KEY CHECK!\n\n// Chá»‰ gá»­i náº¿u:\n// 1. ChÆ°a gá»­i hÃ´m nay\n// 2. ÄÃ£ tá»›i giá» hoáº·c sáº¯p tá»›i\nif (!hasAlreadySentToday && differenceInSeconds <= 0 && differenceInSeconds > -120) {\n  // HIá»‚N THá»Š notification\n  await notificationService.showImmediateNotification(...);\n  \n  // Cáº¬P NHáº¬T database\n  await supabase\n      .from('medicine_schedule_times')\n      .update({\n        'last_notification_sent_date': todayStr,\n        'notification_sent_count': ((scheduleTimeData['notification_sent_count'] ?? 0) as int) + 1,\n      })\n      .eq('id', scheduleTime.id);\n}\n```\n\n**Status**: âœ… Code Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t (khÃ´ng cáº§n sá»­a thÃªm)\n\n---\n\n## ğŸ§ª CÃ¡ch Kiá»ƒm Tra\n\n### Kiá»ƒm Tra 1: XÃ³a Dá»¯ Liá»‡u CÅ©\n\n```sql\n-- VÃ o Supabase â†’ SQL Editor\n-- XÃ³a notification tracking Ä‘á»ƒ test láº¡i tá»« Ä‘áº§u\nUPDATE public.medicine_schedule_times \nSET last_notification_sent_date = NULL, \n    notification_sent_count = 0;\n```\n\n### Kiá»ƒm Tra 2: ThÃªm Thuá»‘c & Cháº¡y\n\n```\n1. flutter clean\n2. flutter pub get\n3. flutter run\n4. ThÃªm thuá»‘c vá»›i thá»i gian = hiá»‡n táº¡i + 1 phÃºt\n5. Chá» 1 phÃºt â†’ Kiá»ƒm tra logs\n```\n\n### Logs Mong Äá»£i\n\n```\nâœ… Notification triggered for [thuá»‘c]\nğŸ’¾ Marked notification as sent for today: [ID]\n```\n\n**Láº§n kiá»ƒm tra tiáº¿p theo**:\n```\nâ­ï¸ Skipped notification for [thuá»‘c] - already sent today (last: 2025-11-19)\n```\n\n### Kiá»ƒm Tra 3: Xem Database\n\nTrong Supabase:\n1. Table Editor â†’ medicine_schedule_times\n2. Cá»™t `last_notification_sent_date` = 2025-11-19 (hÃ´m nay)\n3. Cá»™t `notification_sent_count` = 1\n\n---\n\n## ğŸ“Š TrÆ°á»›c & Sau\n\n### âŒ TRÆ¯á»šC (Váº¥n Äá»)\n\n```\nBackground task cháº¡y má»—i 15 phÃºt\n        â†“\n14:00: Kiá»ƒm tra thuá»‘c 16:55\n       â†’ ChÆ°a tá»›i giá» â†’ skip\n        â†“\n14:15: Kiá»ƒm tra thuá»‘c 16:55 láº¡i\n       â†’ ChÆ°a tá»›i giá» â†’ skip\n        â†“\n16:55: Kiá»ƒm tra thuá»‘c 16:55\n       â†’ ÄÃ£ tá»›i giá»!\n       â†’ HIá»‚N THá»Š notification #1\n        â†“\n17:00: Background task cháº¡y láº¡i (5 phÃºt sau)\n       â†’ Kiá»ƒm tra láº¡i thuá»‘c 16:55\n       â†’ Váº«n trong window (-2 Ä‘áº¿n +3 phÃºt)\n       â†’ HIá»‚N THá»Š notification #2 (TRÃ™NG! âŒ)\n        â†“\n17:05: Background task cháº¡y láº¡i\n       â†’ HIá»‚N THá»Š notification #3 (TRÃ™NG Ná»®A! âŒ)\n```\n\n### âœ… SAU (ÄÃ£ Sá»­a)\n\n```\nBackground task cháº¡y má»—i 15 phÃºt\n        â†“\n14:00: Kiá»ƒm tra thuá»‘c 16:55\n       â†’ ChÆ°a tá»›i giá» â†’ skip\n        â†“\n16:55: Kiá»ƒm tra thuá»‘c 16:55\n       â†’ ÄÃ£ tá»›i giá»!\n       â†’ ChÆ°a gá»­i hÃ´m nay â†’ HIá»‚N THá»Š\n       â†’ Cáº¬P NHáº¬T database: last_notification_sent_date = 2025-11-19\n        â†“\n17:00: Background task cháº¡y láº¡i\n       â†’ Kiá»ƒm tra láº¡i thuá»‘c 16:55\n       â†’ Váº«n Ä‘ang check...\n       â†’ NHÆ¯NG: last_notification_sent_date == hÃ´m nay\n       â†’ â­ï¸ Bá» QUA (skip)\n        â†“\n17:05: Background task cháº¡y láº¡i\n       â†’ â­ï¸ Bá» QUA (skip) - Ä‘Ã£ gá»­i hÃ´m nay\n        â†“\nâœ… Chá»‰ 1 notification! KhÃ´ng trÃ¹ng!\n```\n\n---\n\n## ğŸ”„ NgÃ y Tiáº¿p Theo\n\n```\nNgÃ y hÃ´m sau (2025-11-20)\n        â†“\n16:55: Background task kiá»ƒm tra\n       â†’ last_notification_sent_date = 2025-11-19 (hÃ´m qua)\n       â†’ KHÃ”NG = hÃ´m nay (2025-11-20)\n       â†’ âœ… Gá»¬I notification láº¡i (vÃ¬ ngÃ y khÃ¡c)\n       â†’ Cáº¬P NHáº¬T: last_notification_sent_date = 2025-11-20\n```\n\n**Result**: Má»—i ngÃ y má»™t notification, khÃ´ng trÃ¹ng láº·p! âœ…\n\n---\n\n## ğŸ“‹ SQL Äá»ƒ Debug\n\n### Xem Tráº¡ng ThÃ¡i Notification\n\n```sql\nSELECT \n  mst.id,\n  mst.time_of_day,\n  mst.last_notification_sent_date,\n  mst.notification_sent_count,\n  um.name as medicine_name\nFROM medicine_schedule_times mst\nJOIN medicine_schedules ms ON mst.medicine_schedule_id = ms.id\nJOIN user_medicines um ON ms.user_medicine_id = um.id\nORDER BY um.name, mst.time_of_day;\n```\n\n### XÃ³a Tracking (Reset Test)\n\n```sql\nUPDATE medicine_schedule_times\nSET \n  last_notification_sent_date = NULL,\n  notification_sent_count = 0;\n```\n\n### XÃ³a Cho Má»™t Thuá»‘c\n\n```sql\nUPDATE medicine_schedule_times mst\nSET \n  last_notification_sent_date = NULL,\n  notification_sent_count = 0\nWHERE medicine_schedule_id IN (\n  SELECT id FROM medicine_schedules \n  WHERE user_medicine_id = 'YOUR_MEDICINE_ID_HERE'\n);\n```\n\n---\n\n## ğŸ› ï¸ Troubleshooting\n\n### Lá»—i: \"Column not found\"\n\n```\nâ†’ Cháº¡y SQL migration láº¡i\nâ†’ Kiá»ƒm tra báº£ng Ä‘Ã£ cÃ³ cá»™t khÃ´ng\nâ†’ Refresh database connection\n```\n\n### Lá»—i: \"Invalid query\"\n\n```\nâ†’ Kiá»ƒm tra SQL syntax\nâ†’ Kiá»ƒm tra tÃªn cá»™t chÃ­nh xÃ¡c\nâ†’ Xem Supabase logs\n```\n\n### Váº«n Gá»­i Nhiá»u Notification\n\n```\nâ†’ Kiá»ƒm tra: last_notification_sent_date cÃ³ Ä‘Æ°á»£c update khÃ´ng?\nâ†’ Xem logs: CÃ³ dÃ²ng \"ğŸ’¾ Marked notification as sent\" khÃ´ng?\nâ†’ Xem database: GiÃ¡ trá»‹ cá»§a last_notification_sent_date\nâ†’ XÃ³a data test, test láº¡i tá»« Ä‘áº§u\n```\n\n---\n\n## âœ… Kiá»ƒm Tra Cuá»‘i CÃ¹ng\n\n- [ ] SQL migration cháº¡y thÃ nh cÃ´ng (2 cá»™t má»›i cÃ³ trong Supabase)\n- [ ] Code Ä‘Ã£ cáº­p nháº­t (background_task_service.dart)\n- [ ] Flutter clean & pub get\n- [ ] ThÃªm thuá»‘c test\n- [ ] Logs cÃ³ hiá»ƒn thá»‹ \"Marked notification as sent\"\n- [ ] Notification chá»‰ hiá»‡n 1 láº§n (khÃ´ng trÃ¹ng)\n- [ ] Database update Ä‘Ãºng (last_notification_sent_date = hÃ´m nay)\n- [ ] NgÃ y hÃ´m sau, notification hiá»‡n láº¡i (vÃ¬ ngÃ y khÃ¡c)\n\n---\n\n## ğŸ“ Káº¿t Quáº£ Mong Äá»£i\n\n**TrÆ°á»›c**: Notification trÃ¹ng láº·p 2-4 láº§n cÃ¹ng lÃºc âŒ  \n**Sau**: Notification chá»‰ 1 láº§n má»—i ngÃ y âœ…\n\n**Performance**: +1 query database má»—i 15 phÃºt (khÃ´ng Ä‘Ã¡ng ká»ƒ)\n\n---\n\n**Version**: 1.0  \n**Status**: âœ… Ready to implement\n"