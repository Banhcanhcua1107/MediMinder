# üìã H∆Ø·ªöNG D·∫™N CHI TI·∫æT - H·ªá Th·ªëng Theo D√µi Ch·ªâ S·ªë S·ª©c Kh·ªèe

**Ng√†y c·∫≠p nh·∫≠t:** 21 th√°ng 11, 2025
**Phi√™n b·∫£n:** 1.0
**Tr·∫°ng th√°i:** S·∫µn s√†ng tri·ªÉn khai

---

## üìö M·ª•c L·ª•c

1. [Gi·ªõi Thi·ªáu H·ªá Th·ªëng](#1-gi·ªõi-thi·ªáu-h·ªá-th·ªëng)
2. [C√°ch C√†i ƒê·∫∑t C∆° S·ªü D·ªØ Li·ªáu](#2-c√°ch-c√†i-ƒë·∫∑t-c∆°-s·ªü-d·ªØ-li·ªáu)
3. [C·∫•u Tr√∫c T·ªáp V√† Folder](#3-c·∫•u-tr√∫c-t·ªáp-v√†-folder)
4. [H∆∞·ªõng D·∫´n T√≠ch H·ª£p M√£](#4-h∆∞·ªõng-d·∫´n-t√≠ch-h·ª£p-m√£)
5. [C√°ch S·ª≠ D·ª•ng Repository](#5-c√°ch-s·ª≠-d·ª•ng-repository)
6. [H∆∞·ªõng D·∫´n Giao Di·ªán Ng∆∞·ªùi D√πng](#6-h∆∞·ªõng-d·∫´n-giao-di·ªán-ng∆∞·ªùi-d√πng)
7. [T√≠ch H·ª£p Redmi Watch](#7-t√≠ch-h·ª£p-redmi-watch)
8. [Ki·ªÉm Tra V√† Test](#8-ki·ªÉm-tra-v√†-test)
9. [Kh·∫Øc Ph·ª•c S·ª± C·ªë](#9-kh·∫Øc-ph·ª•c-s·ª±-c·ªë)
10. [C√¢u H·ªèi Th∆∞·ªùng G·∫∑p](#10-c√¢u-h·ªèi-th∆∞·ªùng-g·∫∑p)

---

## 1. Gi·ªõi Thi·ªáu H·ªá Th·ªëng

### M·ª•c ƒê√≠ch
H·ªá th·ªëng theo d√µi ch·ªâ s·ªë s·ª©c kh·ªèe cho ph√©p ng∆∞·ªùi d√πng:
- ‚úÖ **Nh·∫≠p th·ªß c√¥ng** ch·ªâ s·ªë s·ª©c kh·ªèe (BMI, huy·∫øt √°p, nh·ªãp tim, v.v.)
- ‚úÖ **ƒê·ªìng b·ªô t·ª± ƒë·ªông** d·ªØ li·ªáu t·ª´ Redmi Watch / Mi Fitness
- ‚úÖ **Xem ti·∫øn ƒë·ªô** theo ng√†y, tu·∫ßn, th√°ng
- ‚úÖ **L∆∞u tr·ªØ l·ªãch s·ª≠** t·∫•t c·∫£ c√°c ch·ªâ s·ªë ƒëo ƒë∆∞·ª£c

### C√°c Ch·ªâ S·ªë ƒê∆∞·ª£c H·ªó Tr·ª£

| Ch·ªâ S·ªë | Vi·∫øt T·∫Øt | ƒê∆°n V·ªã | Ph·∫°m Vi B√¨nh Th∆∞·ªùng |
|--------|----------|--------|------------------|
| **Ch·ªâ S·ªë Kh·ªëi C∆° Th·ªÉ** | BMI | kg/m¬≤ | 18.5 - 24.9 |
| **Huy·∫øt √Åp** | BP | mmHg | 120/80 |
| **Nh·ªãp Tim** | HR | bpm | 60 - 100 |
| **ƒê∆∞·ªùng Huy·∫øt** | Glucose | mg/dL | 70 - 100 (khi ƒë√≥i) |
| **Cholesterol** | Chol | mg/dL | < 200 |

### Ki·∫øn Tr√∫c H·ªá Th·ªëng

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Flutter UI Layer                      ‚îÇ
‚îÇ  (HealthScreen, AddHealthProfileScreen, Charts)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            Repository Layer (Data Access)              ‚îÇ
‚îÇ  (HealthMetricsRepository - 15+ methods)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Service Layer (Business Logic)                 ‚îÇ
‚îÇ  (MiFitnessIntegrationService for Redmi Watch)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Supabase PostgreSQL (Backend Database)            ‚îÇ
‚îÇ  (user_health_profiles, health_metric_history)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. C√°ch C√†i ƒê·∫∑t C∆° S·ªü D·ªØ Li·ªáu

### üìå B∆∞·ªõc 1: M·ªü Supabase Console

1. Truy c·∫≠p: [https://supabase.com/dashboard](https://supabase.com/dashboard)
2. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n c·ªßa b·∫°n
3. Ch·ªçn project **MediMinder**

### üìå B∆∞·ªõc 2: Ch·∫°y Migration SQL

1. **M·ªü SQL Editor:**
   - Click v√†o **"SQL Editor"** ·ªü sidebar b√™n tr√°i
   - Click **"New Query"**

2. **Copy to√†n b·ªô code t·ª´ file:**
   ```
   MIGRATION_ADD_HEALTH_METRICS.sql
   ```

3. **Paste v√†o SQL Editor** trong Supabase

4. **Nh·∫•p "RUN"** ƒë·ªÉ ch·∫°y

üì∏ **K·∫øt qu·∫£ d·ª± ki·∫øn:**
```
‚úì Tables created successfully
‚úì Indexes created
‚úì RLS policies enabled
‚úì Triggers created
```

### üìå B∆∞·ªõc 3: X√°c Minh C∆° S·ªü D·ªØ Li·ªáu

Sau khi ch·∫°y xong, ki·ªÉm tra:

1. **B·∫£ng ƒë∆∞·ª£c t·∫°o:**
   - Click **"Table Editor"** 
   - Ki·ªÉm tra c√≥ 2 b·∫£ng:
     - `user_health_profiles` 
     - `health_metric_history`

2. **RLS Policies:**
   - Click v√†o b·∫£ng `user_health_profiles`
   - Click **"Authentication"** ‚Üí **"Policies"**
   - Ki·ªÉm tra c√≥ 4 policies:
     - `SELECT - Users can view own profile`
     - `INSERT - Users can create own profile`
     - `UPDATE - Users can update own profile`
     - `DELETE - Users can delete own profile`

3. **Indexes ƒë∆∞·ª£c t·∫°o:**
   - Click v√†o b·∫£ng `health_metric_history`
   - Scroll xu·ªëng **"Indexes"**
   - Ki·ªÉm tra 4 indexes t·ªìn t·∫°i

**‚úÖ N·∫øu m·ªçi th·ª© OK ‚Üí Ti·∫øp t·ª•c b∆∞·ªõc 3**

---

## 3. C·∫•u Tr√∫c T·ªáp V√† Folder

### Danh S√°ch T·ªáp ƒê∆∞·ª£c T·∫°o

```
lib/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ health_metric.dart              # ‚úÖ HealthMetric & HealthProfile classes
‚îÇ
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ health_metrics_repository.dart  # ‚úÖ Data access layer (15+ methods)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ mi_fitness_integration_service.dart  # ‚úÖ Redmi Watch integration
‚îÇ
‚îî‚îÄ‚îÄ screens/
    ‚îî‚îÄ‚îÄ health_screen.dart              # ‚úÖ Main UI (C·∫¶N T·∫†O L·∫†I)

T·ªáp Migration:
‚îî‚îÄ‚îÄ MIGRATION_ADD_HEALTH_METRICS.sql    # ‚úÖ Database schema

T·ªáp T√†i Li·ªáu:
‚îú‚îÄ‚îÄ HEALTH_METRICS_IMPLEMENTATION.md
‚îú‚îÄ‚îÄ HEALTH_SETUP_QUICK_GUIDE.md
‚îú‚îÄ‚îÄ HEALTH_SYSTEM_SUMMARY.md
‚îú‚îÄ‚îÄ ARCHITECTURE_DIAGRAMS.md
‚îî‚îÄ‚îÄ HUONG_DAN_CHI_TIET.md (file n√†y)
```

### T·ªáp N√†o ƒê√£ ƒê∆∞·ª£c X√≥a
- ‚ùå `lib/screens/health_screen.dart` (b·ªã x√≥a, c·∫ßn t·∫°o l·∫°i)

### T·ªáp N√†o C·∫ßn C·∫≠p Nh·∫≠t
- ‚ö†Ô∏è `lib/screens/add_health_screen.dart` (c·∫ßn th√™m t√≠ch h·ª£p repository)

---

## 4. H∆∞·ªõng D·∫´n T√≠ch H·ª£p M√£

### üìå B∆∞·ªõc 1: T·∫°o Health Screen M·ªõi

File: `lib/screens/health_screen.dart`

T·∫°o t·ªáp m·ªõi v·ªõi n·ªôi dung:

```dart
import 'package:flutter/material.dart';
import 'package:mediminder/models/health_metric.dart';
import 'package:mediminder/repositories/health_metrics_repository.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:intl/intl.dart';

class HealthScreen extends StatefulWidget {
  const HealthScreen({Key? key}) : super(key: key);

  @override
  State<HealthScreen> createState() => _HealthScreenState();
}

class _HealthScreenState extends State<HealthScreen> {
  late HealthMetricsRepository _repository;
  HealthProfile? _healthProfile;
  List<HealthMetric> _weeklyMetrics = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _repository = HealthMetricsRepository();
    _loadData();
  }

  Future<void> _loadData() async {
    try {
      setState(() => _isLoading = true);

      final user = Supabase.instance.client.auth.currentUser;
      if (user == null) return;

      final profile = await _repository.getUserHealthProfile(user.id);
      final weeklyMetrics = await _repository.getWeeklyMetrics(user.id);

      setState(() {
        _healthProfile = profile;
        _weeklyMetrics = weeklyMetrics;
        _isLoading = false;
      });
    } catch (e) {
      print('Error loading data: $e');
      setState(() => _isLoading = false);
    }
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      _loadData();
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    if (_healthProfile?.hasData != true) {
      return _buildEmptyState();
    }

    return _buildContent();
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Icon(Icons.health_and_safety, size: 80, color: Colors.grey),
          const SizedBox(height: 16),
          const Text(
            'Kh√¥ng c√≥ d·ªØ li·ªáu s·ª©c kh·ªèe',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 8),
          const Text(
            'H√£y th√™m ch·ªâ s·ªë s·ª©c kh·ªèe c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu',
            textAlign: TextAlign.center,
            style: TextStyle(color: Colors.grey),
          ),
          const SizedBox(height: 24),
          ElevatedButton.icon(
            onPressed: () {
              Navigator.of(context).pushNamed('/add_health');
            },
            icon: const Icon(Icons.add),
            label: const Text('Nh·∫≠p Ch·ªâ S·ªë S·ª©c Kh·ªèe'),
          ),
          const SizedBox(height: 12),
          ElevatedButton.icon(
            onPressed: () {
              // TODO: T√≠ch h·ª£p Redmi Watch
            },
            icon: const Icon(Icons.watch_later_outlined),
            label: const Text('ƒê·ªìng B·ªô t·ª´ Redmi Watch'),
          ),
        ],
      ),
    );
  }

  Widget _buildContent() {
    return RefreshIndicator(
      onRefresh: _loadData,
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildHeader(),
            const SizedBox(height: 16),
            if (_healthProfile?.bmi != null) _buildBMICard(),
            const SizedBox(height: 16),
            if (_healthProfile?.bloodPressureSystolic != null ||
                _healthProfile?.heartRate != null)
              _buildVitalsGrid(),
            const SizedBox(height: 16),
            if (_weeklyMetrics.isNotEmpty) _buildWeeklyProgressCard(),
            const SizedBox(height: 16),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'Ch·ªâ S·ªë S·ª©c Kh·ªèe',
                style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
              ),
              Text(
                'C·∫≠p nh·∫≠t: ${DateFormat('HH:mm, dd/MM').format(DateTime.now())}',
                style: const TextStyle(color: Colors.grey, fontSize: 12),
              ),
            ],
          ),
          Row(
            children: [
              IconButton(
                icon: const Icon(Icons.refresh),
                onPressed: _loadData,
              ),
              IconButton(
                icon: const Icon(Icons.add),
                onPressed: () {
                  Navigator.of(context).pushNamed('/add_health');
                },
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildBMICard() {
    final bmi = _healthProfile!.bmi!;
    final normalizedValue = (bmi / 40 * 100).clamp(0.0, 100.0);

    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 16),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  'Ch·ªâ S·ªë Kh·ªëi C∆° Th·ªÉ (BMI)',
                  style: TextStyle(fontWeight: FontWeight.bold),
                ),
                Text(
                  '${bmi.toStringAsFixed(1)} kg/m¬≤',
                  style: const TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.blue,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 8),
            LinearProgressIndicator(
              value: normalizedValue / 100,
              minHeight: 8,
              backgroundColor: Colors.grey[300],
              valueColor: AlwaysStoppedAnimation<Color>(
                _getBMIColor(bmi),
              ),
            ),
            const SizedBox(height: 8),
            Text(
              _getBMIStatus(bmi),
              style: TextStyle(
                fontSize: 12,
                color: _getBMIColor(bmi),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildVitalsGrid() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      child: GridView.count(
        crossAxisCount: 2,
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        mainAxisSpacing: 16,
        crossAxisSpacing: 16,
        children: [
          if (_healthProfile?.bloodPressureSystolic != null)
            _buildVitalCard(
              title: 'Huy·∫øt √Åp',
              value:
                  '${_healthProfile!.bloodPressureSystolic}/${_healthProfile!.bloodPressureDiastolic}',
              unit: 'mmHg',
              icon: Icons.favorite,
            ),
          if (_healthProfile?.heartRate != null)
            _buildVitalCard(
              title: 'Nh·ªãp Tim',
              value: '${_healthProfile!.heartRate}',
              unit: 'bpm',
              icon: Icons.favorite,
            ),
          if (_healthProfile?.glucoseLevel != null)
            _buildVitalCard(
              title: 'ƒê∆∞·ªùng Huy·∫øt',
              value: '${_healthProfile!.glucoseLevel}',
              unit: 'mg/dL',
              icon: Icons.bloodtype,
            ),
          if (_healthProfile?.cholesterolLevel != null)
            _buildVitalCard(
              title: 'Cholesterol',
              value: '${_healthProfile!.cholesterolLevel}',
              unit: 'mg/dL',
              icon: Icons.trending_up,
            ),
        ],
      ),
    );
  }

  Widget _buildVitalCard({
    required String title,
    required String value,
    required String unit,
    required IconData icon,
  }) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, color: Colors.blue, size: 28),
            const SizedBox(height: 8),
            Text(
              title,
              style: const TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              value,
              style: const TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Colors.blue,
              ),
            ),
            Text(
              unit,
              style: const TextStyle(fontSize: 10, color: Colors.grey),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildWeeklyProgressCard() {
    // Group by date
    final Map<String, List<HealthMetric>> groupedByDate = {};
    for (final metric in _weeklyMetrics) {
      final dateKey = DateFormat('dd/MM').format(metric.measuredAt!);
      groupedByDate.putIfAbsent(dateKey, () => []).add(metric);
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Padding(
          padding: EdgeInsets.symmetric(horizontal: 16),
          child: Text(
            'Ti·∫øn ƒê·ªô Tu·∫ßn',
            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
          ),
        ),
        const SizedBox(height: 8),
        SizedBox(
          height: 120,
          child: ListView.builder(
            scrollDirection: Axis.horizontal,
            padding: const EdgeInsets.symmetric(horizontal: 16),
            itemCount: groupedByDate.length,
            itemBuilder: (context, index) {
              final entries = groupedByDate.entries.toList();
              final dateKey = entries[index].key;
              final metrics = entries[index].value;

              final avgValue = metrics
                      .map((m) => m.valueNumeric ?? 0)
                      .reduce((a, b) => a + b) /
                  metrics.length;
              final normalizedHeight = (avgValue / 100 * 100).clamp(0.0, 100.0);

              return Padding(
                padding: const EdgeInsets.symmetric(horizontal: 4),
                child: Column(
                  children: [
                    Expanded(
                      child: Container(
                        width: 30,
                        decoration: BoxDecoration(
                          color: Colors.blue.withOpacity(0.7),
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Align(
                          alignment: Alignment.bottomCenter,
                          child: Container(
                            height: normalizedHeight / 100 * 100,
                            width: 30,
                            decoration: BoxDecoration(
                              color: Colors.blue,
                              borderRadius: BorderRadius.circular(4),
                            ),
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      dateKey,
                      style: const TextStyle(fontSize: 10),
                    ),
                  ],
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Color _getBMIColor(double bmi) {
    if (bmi < 18.5) return Colors.blue;
    if (bmi < 25) return Colors.green;
    if (bmi < 30) return Colors.orange;
    return Colors.red;
  }

  String _getBMIStatus(double bmi) {
    if (bmi < 18.5) return 'Thi·∫øu c√¢n';
    if (bmi < 25) return 'B√¨nh th∆∞·ªùng';
    if (bmi < 30) return 'Th·ª´a c√¢n';
    return 'B√©o ph√¨';
  }
}
```

### üìå B∆∞·ªõc 2: C·∫≠p Nh·∫≠t AddHealthProfileScreen

File: `lib/screens/add_health_screen.dart`

T√¨m ph∆∞∆°ng th·ª©c `_handleSave()` v√† thay th·∫ø:

**C≈©:**
```dart
void _handleSave() {
  // TODO: Implement save
}
```

**M·ªõi:**
```dart
void _handleSave() async {
  try {
    final user = Supabase.instance.client.auth.currentUser;
    if (user == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui l√≤ng ƒëƒÉng nh·∫≠p')),
      );
      return;
    }

    final repository = HealthMetricsRepository();

    // Create or update profile
    await repository.createHealthProfile(
      userId: user.id,
      bmi: _bmiController.text.isEmpty ? null : double.parse(_bmiController.text),
      bloodPressureSystolic: _systolicController.text.isEmpty 
          ? null 
          : int.parse(_systolicController.text),
      bloodPressureDiastolic: _diastolicController.text.isEmpty 
          ? null 
          : int.parse(_diastolicController.text),
      heartRate: _heartRateController.text.isEmpty 
          ? null 
          : int.parse(_heartRateController.text),
      glucoseLevel: _glucoseController.text.isEmpty 
          ? null 
          : double.parse(_glucoseController.text),
      cholesterolLevel: _cholesterolController.text.isEmpty 
          ? null 
          : double.parse(_cholesterolController.text),
      notes: _notesController.text,
    );

    // Add to metric history
    if (_bmiController.text.isNotEmpty) {
      await repository.addHealthMetric(
        userId: user.id,
        metricType: 'bmi',
        valueNumeric: double.parse(_bmiController.text),
        unit: 'kg/m¬≤',
        source: 'manual',
      );
    }

    // Similar for other metrics...

    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('‚úì ƒê√£ l∆∞u ch·ªâ s·ªë s·ª©c kh·ªèe')),
    );

    Navigator.pop(context);
  } catch (e) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('L·ªói: $e')),
    );
  }
}
```

### üìå B∆∞·ªõc 3: C·∫≠p Nh·∫≠t pubspec.yaml

ƒê·∫£m b·∫£o c√°c dependencies sau ƒë√£ ƒë∆∞·ª£c th√™m:

```yaml
dependencies:
  flutter:
    sdk: flutter
  supabase_flutter: ^1.10.0
  intl: ^0.19.0
```

Ch·∫°y:
```bash
flutter pub get
```

---

## 5. C√°ch S·ª≠ D·ª•ng Repository

### Kh·ªüi T·∫°o Repository

```dart
final repository = HealthMetricsRepository();
```

### Ph∆∞∆°ng Th·ª©c Ch√≠nh

#### 1Ô∏è‚É£ **T·∫°o/C·∫≠p Nh·∫≠t H·ªì S∆° S·ª©c Kh·ªèe**

```dart
await repository.createHealthProfile(
  userId: 'user-id-here',
  bmi: 24.5,
  bloodPressureSystolic: 120,
  bloodPressureDiastolic: 80,
  heartRate: 72,
  glucoseLevel: 95.0,
  cholesterolLevel: 190.0,
  notes: 'Good health status',
);
```

#### 2Ô∏è‚É£ **L·∫•y H·ªì S∆° Hi·ªán T·∫°i**

```dart
final profile = await repository.getUserHealthProfile('user-id');
if (profile != null && profile.hasData) {
  print('BMI: ${profile.bmi}');
  print('Heart Rate: ${profile.heartRate}');
}
```

#### 3Ô∏è‚É£ **Th√™m Ch·ªâ S·ªë M·ªõi**

```dart
await repository.addHealthMetric(
  userId: 'user-id',
  metricType: 'blood_pressure', // bmi, blood_pressure, heart_rate, glucose, cholesterol
  valueNumeric: 120.0,
  valueSecondary: 80, // Cho huy·∫øt √°p
  unit: 'mmHg',
  source: 'manual', // manual, mi_fitness, redmi_watch
);
```

#### 4Ô∏è‚É£ **L·∫•y Ch·ªâ S·ªë Trong 7 Ng√†y**

```dart
final weeklyMetrics = await repository.getWeeklyMetrics('user-id');
// Tr·∫£ v·ªÅ list c√°c ch·ªâ s·ªë t·ª´ 7 ng√†y tr∆∞·ªõc
```

#### 5Ô∏è‚É£ **L·∫•y Ch·ªâ S·ªë Trong 30 Ng√†y**

```dart
final monthlyMetrics = await repository.getMonthlyMetrics('user-id');
```

#### 6Ô∏è‚É£ **L·∫•y Ch·ªâ S·ªë H√¥m Nay**

```dart
final todayMetrics = await repository.getTodayMetrics('user-id');
```

#### 7Ô∏è‚É£ **L·∫•y Ch·ªâ S·ªë M·ªõi Nh·∫•t**

```dart
final latest = await repository.getLatestMetricsForAllTypes('user-id');
// Tr·∫£ v·ªÅ map:
// {
//   'bmi': HealthMetric(...),
//   'blood_pressure': HealthMetric(...),
//   ...
// }
```

#### 8Ô∏è‚É£ **T√≠nh Trung B√¨nh/Min/Max**

```dart
final stats = await repository.getMetricAggregate(
  userId: 'user-id',
  metricType: 'heart_rate',
  fromDate: DateTime.now().subtract(Duration(days: 7)),
  toDate: DateTime.now(),
);

print('Average: ${stats['average']}');
print('Min: ${stats['min']}');
print('Max: ${stats['max']}');
print('Count: ${stats['count']}');
```

---

## 6. H∆∞·ªõng D·∫´n Giao Di·ªán Ng∆∞·ªùi D√πng

### M√†n H√¨nh Health (Tr·ªëng)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [=]        Ch·ªâ S·ªë S·ª©c Kh·ªèe   [‚â°] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                 ‚îÇ
‚îÇ         ‚ù§Ô∏è (Icon l·ªõn)            ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ   Kh√¥ng c√≥ d·ªØ li·ªáu s·ª©c kh·ªèe      ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  H√£y th√™m ch·ªâ s·ªë s·ª©c kh·ªèe       ‚îÇ
‚îÇ  c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu             ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ [+] Nh·∫≠p Ch·ªâ S·ªë S·ª©c Kh·ªèe   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ [‚åö] ƒê·ªìng B·ªô t·ª´ Redmi Watch ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### M√†n H√¨nh Health (C√≥ D·ªØ Li·ªáu)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Ch·ªâ S·ªë S·ª©c Kh·ªèe      [üîÑ]  [+]  ‚îÇ
‚îÇ  C·∫≠p nh·∫≠t: 14:30, 21/11         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Ch·ªâ S·ªë Kh·ªëi C∆° Th·ªÉ (BMI)    ‚îÇ‚îÇ
‚îÇ  ‚îÇ                  24.5 kg/m¬≤ ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚îÇ‚îÇ
‚îÇ  ‚îÇ B√¨nh th∆∞·ªùng                  ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Huy·∫øt √Åp      ‚îÇ ‚îÇ Nh·ªãp Tim   ‚îÇ‚îÇ
‚îÇ  ‚îÇ 120/80 mmHg   ‚îÇ ‚îÇ 72 bpm    ‚îÇ‚îÇ
‚îÇ  ‚îÇ                ‚îÇ ‚îÇ            ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚ù§Ô∏è B√¨nh th∆∞·ªùng ‚îÇ ‚îÇ ‚ù§Ô∏è B√¨nh   ‚îÇ‚îÇ
‚îÇ  ‚îÇ                ‚îÇ ‚îÇ    th∆∞·ªùng  ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ ƒê∆∞·ªùng Huy·∫øt    ‚îÇ ‚îÇ Cholesterol‚îÇ‚îÇ
‚îÇ  ‚îÇ 95 mg/dL       ‚îÇ ‚îÇ 190 mg/dL  ‚îÇ‚îÇ
‚îÇ  ‚îÇ                ‚îÇ ‚îÇ            ‚îÇ‚îÇ
‚îÇ  ‚îÇ ü©∏ B√¨nh th∆∞·ªùng  ‚îÇ ‚îÇ üìà B√¨nh   ‚îÇ‚îÇ
‚îÇ  ‚îÇ                ‚îÇ ‚îÇ    th∆∞·ªùng  ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  Ti·∫øn ƒê·ªô Tu·∫ßn                    ‚îÇ
‚îÇ  ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà           ‚îÇ
‚îÇ  21 22 23 24 25 26 27            ‚îÇ
‚îÇ                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### M√†n H√¨nh Nh·∫≠p D·ªØ Li·ªáu (Add Health Screen)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Th√™m Ch·ªâ S·ªë S·ª©c Kh·ªèe      [X]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                  ‚îÇ
‚îÇ  Ch·ªâ S·ªë Kh·ªëi C∆° Th·ªÉ (BMI)       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ 24.5                         ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  Huy·∫øt √Åp (mmHg)                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ 120 H·ªá Th·ªëng ‚îÇ ‚îÇ 80 T√¢m Tr∆∞∆°ng‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  Nh·ªãp Tim (bpm)                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ 72                           ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  ƒê∆∞·ªùng Huy·∫øt (mg/dL)            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ 95                           ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  Cholesterol (mg/dL)            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ 190                          ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  Ghi Ch√∫                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Good health status           ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ      [L∆ØU]              [H·ª¶Y]‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 7. T√≠ch H·ª£p Redmi Watch

### üìå Chu·∫©n B·ªã

ƒê·ªÉ t√≠ch h·ª£p Redmi Watch, b·∫°n c·∫ßn:

1. **T√†i kho·∫£n Xiaomi Cloud:**
   - Truy c·∫≠p: [https://account.xiaomi.com](https://account.xiaomi.com)
   - ƒêƒÉng nh·∫≠p ho·∫∑c t·∫°o t√†i kho·∫£n

2. **Mi Fitness Developer Console:**
   - Truy c·∫≠p: [https://dev.mi.com](https://dev.mi.com)
   - ƒêƒÉng k√Ω ·ª©ng d·ª•ng
   - L·∫•y `Client ID` v√† `Client Secret`

3. **OAuth Callback URL:**
   - Thi·∫øt l·∫≠p: `https://yourdomain.com/auth/callback`

### üìå C·∫•u H√¨nh MiFitnessIntegrationService

File: `lib/services/mi_fitness_integration_service.dart`

```dart
class MiFitnessIntegrationService {
  // TODO: Th√™m Client ID & Secret
  static const String MI_OAUTH_BASE_URL = 
    'https://account.xiaomi.com/oauth2/authorize';
  static const String MI_API_BASE_URL = 
    'https://api.mfit.xiaomi.com';
  
  // L∆∞u Client ID & Secret c·ªßa b·∫°n
  static const String CLIENT_ID = 'YOUR_CLIENT_ID_HERE';
  static const String CLIENT_SECRET = 'YOUR_CLIENT_SECRET_HERE';
}
```

### üìå C√°ch Ho·∫°t ƒê·ªông

```
1. Ng∆∞·ªùi d√πng click "ƒê·ªìng B·ªô t·ª´ Redmi Watch"
   ‚îÇ
   ‚ñº
2. M·ªü WebView ƒë·ªÉ x√°c th·ª±c Xiaomi
   ‚îÇ
   ‚ñº
3. Ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p t√†i kho·∫£n Xiaomi
   ‚îÇ
   ‚ñº
4. Cho ph√©p ·ª©ng d·ª•ng truy c·∫≠p d·ªØ li·ªáu s·ª©c kh·ªèe
   ‚îÇ
   ‚ñº
5. Nh·∫≠n Access Token
   ‚îÇ
   ‚ñº
6. G·ªçi Mi Fitness API ƒë·ªÉ l·∫•y d·ªØ li·ªáu:
   - Daily Steps
   - Heart Rate
   - Sleep Data
   ‚îÇ
   ‚ñº
7. Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang HealthMetric format
   ‚îÇ
   ‚ñº
8. L∆∞u v√†o health_metric_history (source: 'mi_fitness')
   ‚îÇ
   ‚ñº
9. C·∫≠p nh·∫≠t user_health_profiles
   ‚îÇ
   ‚ñº
10. Hi·ªÉn th·ªã d·ªØ li·ªáu tr√™n HealthScreen
```

### üìå H∆∞·ªõng D·∫´n Tri·ªÉn Khai T∆∞∆°ng Lai

**Giai ƒêo·∫°n 1 (Tu·∫ßn 1-2):**
- ‚úÖ Setup Xiaomi Developer Account
- ‚úÖ L·∫•y Client ID & Secret
- ‚úÖ Thi·∫øt l·∫≠p OAuth Callback URL

**Giai ƒêo·∫°n 2 (Tu·∫ßn 2-3):**
- üîÑ Tri·ªÉn khai OAuth Flow
- üîÑ X√¢y d·ª±ng WebView for Authentication
- üîÑ Token Storage & Refresh

**Giai ƒêo·∫°n 3 (Tu·∫ßn 3-4):**
- üîÑ Tri·ªÉn khai API Calls
- üîÑ Data Transformation
- üîÑ Save to Repository

**Giai ƒêo·∫°n 4 (Tu·∫ßn 4):**
- üîÑ Auto-Sync Scheduling
- üîÑ Background Tasks
- üîÑ Testing & QA

---

## 8. Ki·ªÉm Tra V√† Test

### üìå B∆∞·ªõc 1: Ki·ªÉm Tra Database

Ch·∫°y c√°c truy v·∫•n n√†y trong Supabase SQL Editor:

```sql
-- 1. Ki·ªÉm tra b·∫£ng user_health_profiles
SELECT * FROM user_health_profiles WHERE user_id = 'your-user-id';

-- 2. Ki·ªÉm tra b·∫£ng health_metric_history
SELECT * FROM health_metric_history 
WHERE user_id = 'your-user-id' 
ORDER BY measured_at DESC;

-- 3. Ki·ªÉm tra RLS policies
SELECT * FROM pg_policies 
WHERE tablename IN ('user_health_profiles', 'health_metric_history');

-- 4. Ki·ªÉm tra indexes
SELECT * FROM pg_indexes 
WHERE tablename IN ('user_health_profiles', 'health_metric_history');
```

### üìå B∆∞·ªõc 2: Unit Tests

T·∫°o file: `test/repositories/health_metrics_repository_test.dart`

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mediminder/models/health_metric.dart';
import 'package:mediminder/repositories/health_metrics_repository.dart';

void main() {
  group('HealthMetricsRepository', () {
    late HealthMetricsRepository repository;

    setUp(() {
      repository = HealthMetricsRepository();
    });

    test('HealthMetric fromJson works correctly', () {
      final json = {
        'id': 'test-id',
        'user_id': 'user-id',
        'metric_type': 'bmi',
        'value_numeric': 24.5,
        'unit': 'kg/m¬≤',
        'source': 'manual',
        'measured_at': '2025-11-21T10:30:00Z',
      };

      final metric = HealthMetric.fromJson(json);
      
      expect(metric.id, 'test-id');
      expect(metric.metricType, 'bmi');
      expect(metric.valueNumeric, 24.5);
    });

    test('HealthProfile hasData returns true when bmi is set', () {
      final profile = HealthProfile(
        id: 'id',
        userId: 'user-id',
        bmi: 24.5,
        bloodPressureSystolic: null,
        bloodPressureDiastolic: null,
        heartRate: null,
        glucoseLevel: null,
        cholesterolLevel: null,
        notes: null,
        lastUpdatedAt: DateTime.now(),
        createdAt: DateTime.now(),
        updatedAt: DateTime.now(),
      );

      expect(profile.hasData, true);
    });
  });
}
```

Ch·∫°y tests:
```bash
flutter test test/repositories/health_metrics_repository_test.dart
```

### üìå B∆∞·ªõc 3: Integration Tests

T·∫°o file: `test/screens/health_screen_test.dart`

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:mediminder/screens/health_screen.dart';

void main() {
  group('HealthScreen', () {
    testWidgets('Shows empty state when no data', (WidgetTester tester) async {
      await tester.pumpWidget(
        const MaterialApp(
          home: HealthScreen(),
        ),
      );

      expect(find.text('Kh√¥ng c√≥ d·ªØ li·ªáu s·ª©c kh·ªèe'), findsOneWidget);
      expect(find.byIcon(Icons.health_and_safety), findsOneWidget);
    });

    testWidgets('Shows loading spinner initially', (WidgetTester tester) async {
      await tester.pumpWidget(
        const MaterialApp(
          home: HealthScreen(),
        ),
      );

      expect(find.byType(CircularProgressIndicator), findsWidgets);
    });
  });
}
```

Ch·∫°y tests:
```bash
flutter test test/screens/health_screen_test.dart
```

### üìå B∆∞·ªõc 4: Manual Testing Checklist

- [ ] ·ª®ng d·ª•ng kh·ªüi ƒë·ªông kh√¥ng l·ªói
- [ ] HealthScreen hi·ªÉn th·ªã tr·∫°ng th√°i r·ªóng
- [ ] Click "Nh·∫≠p Ch·ªâ S·ªë" ‚Üí AddHealthScreen m·ªü
- [ ] Nh·∫≠p BMI = 24.5, l∆∞u
- [ ] HealthScreen c·∫≠p nh·∫≠t v√† hi·ªÉn th·ªã BMI
- [ ] Chart hi·ªÉn th·ªã ƒë√∫ng
- [ ] Refresh button ho·∫°t ƒë·ªông
- [ ] D·ªØ li·ªáu v·∫´n gi·ªØ nguy√™n sau khi ƒë√≥ng/m·ªü app
- [ ] Th√™m ch·ªâ s·ªë m·ªõi m·ªói ng√†y
- [ ] Chart c·∫≠p nh·∫≠t ch√≠nh x√°c v·ªõi d·ªØ li·ªáu m·ªõi

---

## 9. Kh·∫Øc Ph·ª•c S·ª± C·ªë

### ‚ùå L·ªói: "auth.currentUser is null"

**Nguy√™n nh√¢n:** Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p

**C√°ch s·ª≠a:**
```dart
if (Supabase.instance.client.auth.currentUser == null) {
  // Chuy·ªÉn h∆∞·ªõng sang trang ƒëƒÉng nh·∫≠p
  Navigator.of(context).pushNamed('/login');
  return;
}
```

### ‚ùå L·ªói: "RLS policy violation"

**Nguy√™n nh√¢n:** RLS policies ch∆∞a ƒë∆∞·ª£c b·∫≠t

**C√°ch s·ª≠a:**
1. M·ªü Supabase Console
2. Table Editor ‚Üí Ch·ªçn b·∫£ng
3. Authentication ‚Üí Policies
4. B·∫≠t t·∫•t c·∫£ 4 policies

### ‚ùå L·ªói: "health_metric_history table not found"

**Nguy√™n nh√¢n:** Migration SQL ch∆∞a ch·∫°y

**C√°ch s·ª≠a:**
1. M·ªü SQL Editor
2. Ch·∫°y l·∫°i MIGRATION_ADD_HEALTH_METRICS.sql
3. X√°c minh b·∫£ng ƒë∆∞·ª£c t·∫°o trong Table Editor

### ‚ùå L·ªói: "Chart not displaying correctly"

**Nguy√™n nh√¢n:** Normalization value sai

**C√°ch s·ª≠a:**
Ki·ªÉm tra c√¥ng th·ª©c:
```dart
final normalizedHeight = (avgValue / 100 * 100).clamp(0.0, 100.0);
// ƒê√¢y ch·ªâ l√† chia 100, sau ƒë√≥ nh√¢n 100
// N√™n ch·ªânh s·ª≠a th√†nh:
final normalizedHeight = ((avgValue / MAX_VALUE) * 100).clamp(0.0, 100.0);
// Trong ƒë√≥ MAX_VALUE ph·ª• thu·ªôc v√†o metric type
```

### ‚ùå L·ªói: "NoSuchMethodError: value_numeric"

**Nguy√™n nh√¢n:** Column name kh√¥ng ƒë√∫ng

**C√°ch s·ª≠a:**
Ki·ªÉm tra t√™n column trong SQL:
```sql
-- Xem c√°c column trong health_metric_history
SELECT * FROM information_schema.columns 
WHERE table_name = 'health_metric_history';
```

---

## 10. C√¢u H·ªèi Th∆∞·ªùng G·∫∑p

### ‚ùì Q1: L√†m c√°ch n√†o ƒë·ªÉ x√≥a d·ªØ li·ªáu c≈©?

**Tr·∫£ l·ªùi:**
```dart
// X√≥a m·ªôt metric c·ª• th·ªÉ
await repository.deleteHealthMetric(metricId);

// X√≥a t·∫•t c·∫£ d·ªØ li·ªáu c·ªßa ng∆∞·ªùi d√πng
await Supabase.instance.client
    .from('health_metric_history')
    .delete()
    .eq('user_id', userId);
```

### ‚ùì Q2: T√¥i c√≥ th·ªÉ t√≠ch h·ª£p Fitbit ho·∫∑c Apple Health kh√¥ng?

**Tr·∫£ l·ªùi:**
C√≥ th·ªÉ! C·∫•u tr√∫c repository cho ph√©p nhi·ªÅu ngu·ªìn d·ªØ li·ªáu:
```dart
// C√≥ th·ªÉ l√† 'manual', 'mi_fitness', 'fitbit', 'apple_health', v.v.
await repository.addHealthMetric(
  userId: userId,
  source: 'fitbit', // ho·∫∑c 'apple_health'
  ...
);
```

### ‚ùì Q3: L√†m sao ƒë·ªÉ so s√°nh ti·∫øn ƒë·ªô?

**Tr·∫£ l·ªùi:**
```dart
// L·∫•y d·ªØ li·ªáu tu·∫ßn tr∆∞·ªõc
final lastWeek = await repository.getMetricAggregate(
  userId: userId,
  metricType: 'heart_rate',
  fromDate: DateTime.now().subtract(Duration(days: 14)),
  toDate: DateTime.now().subtract(Duration(days: 7)),
);

// L·∫•y d·ªØ li·ªáu tu·∫ßn n√†y
final thisWeek = await repository.getMetricAggregate(
  userId: userId,
  metricType: 'heart_rate',
  fromDate: DateTime.now().subtract(Duration(days: 7)),
  toDate: DateTime.now(),
);

// So s√°nh
final difference = thisWeek['average']! - lastWeek['average']!;
```

### ‚ùì Q4: T√¥i c√≥ th·ªÉ xu·∫•t d·ªØ li·ªáu kh√¥ng?

**Tr·∫£ l·ªùi:**
```dart
// L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu
final allMetrics = await repository.getMonthlyMetrics(userId);

// Chuy·ªÉn sang JSON
final jsonData = allMetrics.map((m) => m.toJson()).toList();

// L∆∞u ho·∫∑c chia s·∫ª
// C√≥ th·ªÉ l∆∞u sang CSV, PDF, ho·∫∑c g·ª≠i qua email
```

### ‚ùì Q5: T√¥i c·∫ßn g√¨ ƒë·ªÉ tri·ªÉn khai l√™n production?

**Tr·∫£ l·ªùi:**
1. ‚úÖ Ho√†n th√†nh migration SQL
2. ‚úÖ Ki·ªÉm tra t·∫•t c·∫£ RLS policies
3. ‚úÖ Ki·ªÉm tra t·∫•t c·∫£ unit tests
4. ‚úÖ Ki·ªÉm tra manual testing
5. ‚úÖ C·∫•u h√¨nh OAuth cho Xiaomi (n·∫øu c·∫ßn)
6. ‚úÖ Thi·∫øt l·∫≠p monitoring & logging
7. ‚úÖ Backup database

### ‚ùì Q6: L√†m sao ƒë·ªÉ reset/cleanup d·ªØ li·ªáu?

**Tr·∫£ l·ªùi:**
```bash
# X√≥a t·∫•t c·∫£ d·ªØ li·ªáu (c·∫©n th·∫≠n!)
flutter pub run migrate_sql --down

# Ho·∫∑c ch·∫°y l·∫°i migration
flutter pub run migrate_sql --up
```

---

## üìû H·ªó Tr·ª£ & Li√™n L·∫°c

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ:

1. **Ki·ªÉm tra t√†i li·ªáu:**
   - HEALTH_METRICS_IMPLEMENTATION.md
   - HEALTH_SETUP_QUICK_GUIDE.md
   - ARCHITECTURE_DIAGRAMS.md

2. **Ki·ªÉm tra logs:**
   ```bash
   flutter logs
   ```

3. **Ki·ªÉm tra Supabase:**
   - M·ªü Supabase Console
   - Xem Logs ‚Üí Query Logs
   - Ki·ªÉm tra errors

4. **Li√™n h·ªá:**
   - Repository: [GitHub Link]
   - Email: support@mediminder.com

---

## üéØ Roadmap Ti·∫øp Theo

### Tu·∫ßn 1 (Hi·ªán T·∫°i)
- ‚úÖ Database Schema
- ‚úÖ Models & Repository
- ‚úÖ HealthScreen UI
- ‚è≥ Integration Testing

### Tu·∫ßn 2-3
- üîÑ Xiaomi OAuth Integration
- üîÑ Mi Fitness API Implementation
- üîÑ Auto-Sync Feature

### Tu·∫ßn 4
- üîÑ Notification System
- üîÑ Data Export (CSV, PDF)
- üîÑ Advanced Analytics

### Tu·∫ßn 5+
- üîÑ Apple Health Integration
- üîÑ Fitbit Integration
- üîÑ Machine Learning Predictions
- üîÑ Social Features (share, compare)

---

## üìÑ T√†i Li·ªáu Li√™n Quan

- **MIGRATION_ADD_HEALTH_METRICS.sql** - Database schema
- **HEALTH_METRICS_IMPLEMENTATION.md** - Technical details
- **HEALTH_SETUP_QUICK_GUIDE.md** - Quick setup
- **ARCHITECTURE_DIAGRAMS.md** - System diagrams
- **HEALTH_SYSTEM_SUMMARY.md** - Project overview

---

**Phi√™n b·∫£n:** 1.0
**C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:** 21 Th√°ng 11, 2025
**Tr·∫°ng th√°i:** ‚úÖ S·∫µn s√†ng tri·ªÉn khai
